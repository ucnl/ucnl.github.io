| ![logo](https://ucnl.github.io/documentation/sm_logo.png) |  |
| :---: | ---: |
| [www.unavlab.com](https://www.unavlab.com/) <br/> [support@unavlab.com](mailto:support@unavlab.com) | **RedWAVE** - гидроакустическая навигационная система <br/> Протокол информационного сопряжения c навигационным приемником RedNODE |
  
# ДАННЫЙ ДОКУМЕНТ НАХОДИТСЯ В РАЗРАБОТКЕ И НЕВАЛИДЕН!
## Воспользуйтесь [предыдущей версией документа](https://docs.unavlab.com/Docs/RU/RedWAVE/RedNODE_Protocol_specification.pdf)
  
# RedWAVE <br/> протокол информационного сопряжения c навигационными приемниками RedNODE

<div style="page-break-after: always;"></div>

## Содержание
- [1. Введение](#1-%D0%B2%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5)  
  - [1.1. Протокол физического уровня](#11-%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%BB-%D1%84%D0%B8%D0%B7%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B3%D0%BE-%D1%83%D1%80%D0%BE%D0%B2%D0%B5%D0%BD%D1%8F)
  - [1.2. Стандарт протокола диалогового уровня NMEA0183](#12-%D1%81%D1%82%D0%B0%D0%BD%D0%B4%D0%B0%D1%80%D1%82-%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%BB%D0%B0-%D0%B4%D0%B8%D0%B0%D0%BB%D0%BE%D0%B3%D0%BE%D0%B2%D0%BE%D0%B3%D0%BE-%D1%83%D1%80%D0%BE%D0%B2%D0%BD%D1%8F-nmea0183)

   
<div style="page-break-after: always;"></div>

## 1. Введение
### 1.1. Протокол физического уровеня
Гидроакустические навигационные приемники **[RedNODE](RedNODE_Specification_ru.md)** поддерживают информационное сопряжение при помощи 
стандарта физического уровня RS-232 для асинхронного интерфейса (UART) c напряжением линии данных 3.3В. Подключение производится при помощи 
четырехпроводного кабеля, с жилами Tx (трансмиттер), Rx (ресивер), Vcc (питание)  и GND (земля). Без применения дополнительных повторителей 
и преобразователей интерфейса максимальная длинна шины данных, для которой гарантируется корректная работа интерфейса, составляет не более 2 метров.  

Настройки порта подключения по умолчанию<sup>[1](#footnote1)</sup>:  
> _Baudrate: 9600 bit/s_  
> _Data bits: 8_  
> _Stop bits: 1_  
> _Parity: No_  
> _Hardware flow control: No_  

>**ВНИМАНИЕ!**
>_Питание модемов осуществляется от источника постоянного тока 12 Вольт, при этом напряжение линии данных составляет 3.3 В._

### 1.2. Стандарт протокола диалогового уровня NMEA0183
Стандарт NMEA0183 описывает формат текстовых (ASCII) сообщений диалогового уровня.  

Пример сообщения:  **`$PTNT0,1,0*hh<СR><LF>`**  

Основные элементы посылки (сообщения, sentence) NMEА0183:
* '$' - начало сообщения,
* 'P' - Proprietary, проприетарный код
* 'TNT' - трехбуквенный идентификатор производителя
* '0' - идентификатор сообщения
* ',' - запятая (разделитель параметров)  
* '*' - разделитель контрольной суммы
* 'hh' - контрольная сумма в шестнадцатеричном формате (например FF, 01). Рассчитывается как побитовый XOR всех байт между '$' и '*'.
* \<CR\>\<LF\> - конец сообщения (перевод строки)
________
<a name="footnote1"><sup>1</sup> Указанные параметры могут быть изменены по запросу</a>

<div style="page-break-after: always;"></div>

## 2. Система команд TNT и стандартные сообщения NMEA0183
Префикс **D2H** в наименовании сообщений означает, что оно передается от устройства (Device) к управляющей системе (Host).
Префикс **H2D** в наименовании сообщений означает, что оно передается от управляющей системы (Host) к устройству (Device).

### 2.1. Оснвные и частоупотребимые сообщения

В эту группу входят сообщения, которые устройство передает по умолчанию (в зависимости от своего внутреннего состояния).

#### 2.1.1. GGA
Стандартное сообщение NMEA0183 - Global positioning system fix data.

Формат сообщения: **`$GNGGA,hhmmss.sss,ddmm.mmm,N|S,yyymm.mmm,E|W,x,xx,x.x,x.x,M,x.x,M,xx,xxxx*hh<CR><LF>`**  

| № | Поле/Параметр |	Описание |
| :--- | :--- | :--- |
| | $	| Начало сообщения '$' |
| | GN | Стандартный источник данных - Global navigation |
| | GGA |	Стандартный идентификатор сообщения - Globap positioning system fix data |
| 1 | UTC Time |	UTC, ччммсс.ссс |
| 2 | Latitude |	Географическая широта, ddmm.mmmmmm |
| 3 | N|S | Идентификатор полушария, N - северное, S - южное |
| 4 | Longitude |	Географическая долгота, dddmm.mmmmmm |
| 5 | E|W | Идентификатор полушария, E - восточное, W - западное |
| 6 | Fix Type | Тип навигационного решения | 
| 7 | Satellites in view | Число доступных спутников (в RedWAVE всегда равно 4) |
| 8 | HDOP | Horizontal dilution of precision, метры. (в RedWAVE данное поле передает радиальную ошибку, значение функции невязки в конце решения) |
| 9 | Altitude | Altitude, метры. (в RedWAVE данное поле передает глубину, т.е. высоту со знаком "-") |
| 10 | M |	М - метры |
| 11 | Geoidal separation | Поле не поддерживается и остается пустым |
| 12 | Age of data |  Поле не поддерживается и остается пустым |
| 13 | Reference station ID | Поле не поддерживается и остается пустым |
| | *	| Разделитель контрольной суммы NMEA |
| | hh	| Контрольная сумма NMEA |
| | \<CR\>\<LF\> | Конец сообщения |

#### 2.1.2. RMC
Стандартное сообщение NMEA0183 - Recommended minimum, sentence 'C'.

Формат сообщения: **`$GNRMC,hhmmss.sss,A|V,ddmm.mmm,N|S,dddmm.mmm,E|W,x.x,x.x,ddmmyy,,,A|D|V*hh<CR><LF>`**  

| № | Поле/Параметр |	Описание |
| :--- | :--- | :--- |
|  | $	| Начало сообщения '$' |
|  | GN | Стандартный источник данных - Global navigation |
|  | RMC | Стандартный идентификатор сообщения - Recommended minimum, sentence 'C' |
| 1 | UTC Time |	UTC, ччммсс.ссс |
| 2 | Data quality indicator |	A - данные верны |
| 3 | Latitude |	Географическая широта, ddmm.mmmmmm |
| 4 | N|S | Идентификатор полушария, N - северное, S - южное |
| 5 | Longitude |	Географическая долгота, dddmm.mmmmmm |
| 6 | E|W | Идентификатор полушария, E - восточное, W - западное |
| 7 | Speed |	Поле не поддерживается |
| 8 | Course | Поле не поддерживается |
| 9 | Date | Поле не поддерживается |
| 10 | Magnetic variation | Поле не поддерживается |
| 11 | E|W | Поле не поддерживается |
| 12 | A | Режим, A - GNSS |
|  | *	| Разделитель контрольной суммы NMEA |
|  | hh	| Контрольная сумма NMEA |
|  | \<CR\>\<LF\> | Конец сообщения |

#### 2.1.3. MTW
Стандартное сообщение NMEA0183 - Mean water temperature (Температура воды).

Формат сообщения: **`$GNMTW,x.x,C*hh<CR><LF>`**  

| № | Поле/Параметр |	Описание |
| :--- | :--- | :--- |
|  | $	| Начало сообщения '$' |
|  | GN | Стандартный источник данных - Global navigation |
|  | MTW | Стандартный идентификатор сообщения - Mean temperature of water |
| 1 | Temperature	| Температура воды, ˚C
| 2 | C	| C - Celsius |
|  | *	| Разделитель контрольной суммы NMEA |
|  | hh	| Контрольная сумма NMEA |
|  | \<CR\>\<LF\> | Конец сообщения |

#### 2.1.4. IC_D2H_NEW_PFIX_UPDATE
Обновление географического положения приемника и буев.

Формат сообщения: **`$PTNTC,x,x,x.x,x.x,x.x,x.x,x.x,x.x,x.x,x.x,x.x,x.x,x.x,x.x,x.x*hh<CR><LF>`**

| № | Поле/Параметр |	Описание |
| :--- | :--- | :--- |
|  | $ | Начало сообщения '$' |
|  | P | Проприетарный код |
|  | TNT | Система команд TNT |
|  | C | Sentence identifier |
| 1 | Own location - latitude | Географическая широта, ° |
| 2 | Own location - longitude | Геогрфчиеская долгота, ° |
| 3 | Own location - depth | Глубина, м |
| 4 | Radial error | Радиальная ошибка, м |
| 5 | Buoy #1 latitude | RedBASE №1 геогрфическая широта, ° |
| 6 | Buoy #1 longitude | RedBASE №1 геогрфическая долгота, ° |
| 7 | Buoy #2 latitude | RedBASE №2 геогрфическая широта, ° |
| 8 | Buoy #2 longitude | RedBASE №2 геогрфическая долгота, ° |
| 9 | Buoy #3 latitude | RedBASE №3 геогрфическая широта, ° |
| 10 | Buoy #3 longitude | RedBASE №3 геогрфическая долгота, ° |
| 11 | Buoy #4 latitude | RedBASE №4 геогрфическая широта, ° |
| 12 | Buoy #4 longitude | RedBASE №4 геогрфическая долгота, ° |
| 13 | Temperature | Температура воды, ˚C |
|  | *	| Разделитель контрольной суммы NMEA |
|  | hh	| Контрольная сумма NMEA |
|  | \<CR\>\<LF\> | Конец сообщения |

#### 2.1.5. IC_D2H_DPTTMP_VAL
Глубина и температура воды.

Формат сообщения: **`PTNTN,x.x,x.x*hh<CR><LF>`**

| № | Поле/Параметр |	Описание |
| :--- | :--- | :--- |
|  | $ | Начало сообщения '$' |
|  | P | Проприетарный код |
|  | TNT | Система команд TNT |
|  | N | Идентификатор сообщения |
| 1 | Depth | Глубина, м |
| 2 | Temperature | Температура воды, ˚C |
|  | *	| Разделитель контрольной суммы NMEA |
|  | hh	| Контрольная сумма NMEA |
|  | \<CR\>\<LF\> | Конец сообщения |
|  | TNT | Система команд TNT |

#### 2.1.6. IC_D2H_BUOY_STATUS
Состояние буев.

Формат сообщения: **`$PTNTM,x.x,x.x,x.x,x,x.x,x.x,x.x,x,x.x,x.x,x.x,x,x.x,x.x,x.x,x*hh<CR><LF>`**

| № | Поле/Параметр |	Описание |
| :--- | :--- | :--- |
|  | $ | Начало сообщения '$' |
|  | P | Проприетарный код |
|  | TNT | Система команд TNT |
|  | M | Sentence identifier |
| 1 | Buoy #1 latitude | RedBASE №1 геогрфическая широта, ° |
| 2 | Buoy #1 longitude | RedBASE №1 геогрфическая долгота, ° |
| 3 | Buoy #1 SNR | RedBASE №1 MSR<sup>[2](#footnote2)</sup>, dB |
| 4 | Buoy #1 status | RedBASE №1 Статус<sup>[3](#footnote3)</sup> |
| 5 | Buoy #2 latitude | RedBASE №2 геогрфическая широта, ° |
| 6 | Buoy #2 longitude | RedBASE №2 геогрфическая долгота, ° |
| 7 | Buoy #2 SNR | RedBASE №2 MSR<sup>[2](#footnote2)</sup>, dB |
| 8 | Buoy #2 status | RedBASE №2 Статус<sup>[3](#footnote3)</sup> |
| 9 | Buoy #3 latitude | RedBASE №3 геогрфическая широта, ° |
| 10 | Buoy #3 longitude | RedBASE №3 геогрфическая долгота, ° |
| 11 | Buoy #3 SNR | RedBASE №3 MSR<sup>[2](#footnote2)</sup>, dB |
| 12 | Buoy #3 status | RedBASE №3 Статус<sup>[3](#footnote3)</sup> |
| 13 | Buoy #4 latitude | RedBASE №4 геогрфическая широта, ° |
| 14 | Buoy #4 longitude | RedBASE №4 геогрфическая долгота, ° |
| 15 | Buoy #4 SNR | RedBASE №4 MSR<sup>[2](#footnote2)</sup>, dB |
| 16 | Buoy #4 status | RedBASE №4 Статус<sup>[3](#footnote3)</sup> |
|  | *	| Разделитель контрольной суммы NMEA |
|  | hh	| Контрольная сумма NMEA |
|  | \<CR\>\<LF\> | Конец сообщения |

________
<a name="footnote2"><sup>2</sup> MSR (_англ. Main lobe to side peak ratio_) - характеристика качества приема сигнала. Хорошие условия приема при значении параметра >= 20 dB.  
<a name="footnote3"><sup>3</sup> Описание возможных значений \([см.x.x]()\)

#### 2.1.7. IC_D2H_PRETMP_VAL
Давление и температура.

Формат сообщения: **`$PTNTO,x.x,x.x*hh<CR><LF>`**

| № | Поле/Параметр |	Описание |
| :--- | :--- | :--- |
|  | $ | Начало сообщения '$' |
|  | P | Проприетарный код |
|  | TNT | Система команд TNT |
|  | O | Идентификатор сообщения |
| 1 | Pressure | Внешнее гидростатическое давление, mBar |
| 2 | Temperature | Температура воды, ˚C |
|  | * | Разделитель контрольной суммы NMEA |
|  | hh	| Контрольная сумма NMEA |
|  | \<CR\>\<LF\> | Конец сообщения |
|  | TNT | Система команд TNT |

#### 2.1.8. IC_H2D_SET_VAL
Запрос на изменение локального параметра.

Формат сообщения: **`$PTNTP,x,x.x<CR><LF>`**

| № | Поле/Параметр |	Описание |
| :--- | :--- | :--- |
|  | $ | Начало сообщения '$' |
|  | P | Проприетарный код |
|  | TNT | Система команд TNT |
|  | P | Идентификатор сообщения |
| 1 | Value ID | Идентификатор параметра \([см.x.x]()\) |
| 2 | Value | Новое значение |
|  | * | Разделитель контрольной суммы NMEA |
|  | hh	| Контрольная сумма NMEA |
|  | \<CR\>\<LF\> | Конец сообщения |
|  | TNT | Система команд TNT |

### 2.2. Дополнительные сообщения

К этой группе сообщений отностятся запросы к устройству от управляющей системы и ответы устройства на них.

#### 2.2.1. IC_D2H_ACK
Реакция устройства на запрос управляющей системы.

Формат сообщения: **`$PTNT0,x*hh<CR><LF>`**  

| № | Поле/Параметр |	Описание |
| :--- | :--- | :--- |
|  | $ | Начало сообщения '$' |
|  | P | Проприетарный код |
|  | TNT | Система команд TNT |
|  | 0	| Идентификатор сообщения |
| 1 | errCode	| Error code \([см.x.x]()\) |
|  | *	| Разделитель контрольной суммы NMEA |
|  | hh	| Контрольная сумма NMEA |
|  | \<CR\>\<LF\> | Конец сообщения |


#### 2.2.2. IC_H2D_LOC_DATA_GET
Запрос локальных данных.

Формат сообщения: **`$PTNT4,xx,00*hh<CR><LF>`**  

| № | Поле/Параметр |	Описание |
| :--- | :--- | :--- |
|  | $ | Начало сообщения '$' |
|  | P | Проприетарный код |
|  | TNT | Система команд TNT |
|  | 4 | Идентификатор сообщения |
| 1 | dataID	| Идентификатор данных \([см.x.x]()\) |
| 2 | reserved | Заразервировано, '00' |
|  | *	| Разделитель контрольной суммы NMEA |
|  | hh	| Контрольная сумма NMEA |
|  | \<CR\>\<LF\> | Конец сообщения |


#### 2.2.3. IC_D2H_LOC_DATA_VAL
Ответ устройства на запрос [IC_H2D_LOC_DATA_GET]() и [IC_H2D_SET_VAL](): устройство передает запрошенные данные.

Формат сообщения: **`$PTNT5,x,x<CR><LF>`**  

| № | Поле/Параметр |	Описание |
| :--- | :--- | :--- |
|  | $ | Начало сообщения '$' |
|  | P | Проприетарный код |
|  | TNT | Система команд TNT |
|  | 5 | Идентификатор сообщения | 
| 1 | Requested data ID | Идентификатор данных \([см.x.x]()\) | 
| 2 | Value | Запрошенное значение | 
|  | *	| Разделитель контрольной суммы NMEA |
|  | hh	| Контрольная сумма NMEA |
|  | \<CR\>\<LF\> | Конец сообщения |


#### 2.2.4. IC_D2H_DEV_INFO_VAL
Ответ устройства на команду [IC_D2H_LOC_DATA_GET](), если идентификатор запрошенных данных = [LOC_DATA_DEV_INFO]().

Формат сообщения: **`$PTNT!,c--c,x,x,c--c,x,c--c<CR><LF>`**  

| № | Поле/Параметр |	Описание |
| :--- | :--- | :--- |
|  | $ | Начало сообщения '$' |
|  | P | Проприетарный код |
|  | TNT | Система команд TNT |
|  | ! | Идентификатор сообщения |
| 1 | System moniker | Наименование системы |
| 2 | System version | Версия системы (BCD) |
| 3 | Communication subsystem moniker | Наименование подсистемы связи |
| 4 | Communication subsystem version | Версия подсистемы связи (BCD) |
| 5 | Device type | Тип устройства \([см.x.x]()\) |
| 6 | Serial number | Серийный номер устройства |
|  | *	| Разделитель контрольной суммы NMEA |
|  | hh	| Контрольная сумма NMEA |
|  | \<CR\>\<LF\> | Конец сообщения |


#### 2.2.5. IC_H2D_SNT_ENABLE
Управление выдачей сообщений.

Формат сообщения: **`$PTNTQ,b,b,b,b,b,b,b*hh<CR><LF>`**  

| № | Поле/Параметр |	Описание |
| :--- | :--- | :--- |
|  | $ | Начало сообщения '$' |
|  | P | Проприетарный код |
|  | TNT | Система команд TNT |
|  | Q | Идентификатор сообщения |
| 1 | isMTW | выдача сообщений [MTW]() (0 - выключена, 1 - включена) |
| 2 | isGGA | выдача сообщений [GGA]() (0 - выключена, 1 - включена) |
| 3 | isRMC | выдача сообщений [RMC]() (0 - выключена, 1 - включена) |
| 4 | isM | выдача сообщений [TNTM]() (0 - выключена, 1 - включена) |
| 5 | isC | выдача сообщений [TNTC]() (0 - выключена, 1 - включена) |
| 6 | isN | выдача сообщений [TNTN]() (0 - выключена, 1 - включена) |
| 7 | isO | выдача сообщений [TNTO]() (0 - выключена, 1 - включена) |
|  | * | Разделитель контрольной суммы NMEA |
|  | hh	| Контрольная сумма NMEA |
|  | \<CR\>\<LF\> | Конец сообщения |


#### 2.2.6. IC_H2D_ACT_INVOKE
Запрос на выполнение сервисной операции.

Формат сообщения: **`$PTNT6,xx,00*hh<CR><LF>`**  

| № | Поле/Параметр |	Описание |
| :--- | :--- | :--- |
|  | $ | Начало сообщения '$' |
|  | P | Проприетарный код |
|  | TNT | Система команд TNT |
|  | 6 | Идентификатор сообщения |
|  | Action ID | Идентификатор сервисной операции \([см.x.x]()\) |
|  | Reserved | Зарезервировано, '00' |
|  | * | Разделитель контрольной суммы NMEA |
|  | hh	| Контрольная сумма NMEA |
|  | \<CR\>\<LF\> | Конец сообщения |

## 3. Таблицы идентификаторов

### 3.1. Типы устройств

| Значение | Наименование | Описание |
| :--- | :--- | :--- |
| '0' | DEVICE_REDBASE | RedBASE гидроакустический буй-ретранслятор |
| '1' | DEVICE_REDNODE | RedNODE навигационный приемник |
| '2' | DEVICE_REDNAV | RedNAV навигационный приемник водолаза |
| '3' | DEVICE_REDGTR | RedGTR модем кодовой связи |

### 3.2. Коды ошибок

| Значение | Наименование | Описание |
| :--- | :--- | :--- |
| '0' | NO_ERROR | Запрос принят, нет ошибок |
| '1' | INVALID_SYNTAX | Ошибка синтаксиса |
| '2' | UNSUPPORTED | Запрос не поддерживается |
| '3' | TRANSMITTER_BUSY | Акустический передатчик занят |
| '4' | ARGUMENT_OUT_OF_RANGE | Аргумент вне диапазона допустимых значений |
| '5' | INVALID_OPERATION | Запрошеная операция не может быть выполнена на этом устройстве |
| '6' | UNKNOWN_FIELD_ID | Неизвестное значение конфигурационного поля |
| '7' | VALUE_UNAVAILIBLE | Запрошенное значение недоступно в данный момент |
| '8' | RECEIVER_BUSY | Акустический приемник ожидает ответа удаленной системы |

### 3.3. Идентификаторы локальных данных

| Значение | Наименование | Описание | RO/RW |
| :--- | :--- | :--- | :--- |
| '0' | DEVICE_INFO | System name, version, acoustic subsystem name and version, device type and serial number	RO
| '1' | MAX_REMOTE_TIMEOUT | Max. remote timeout, msec	RO
| '2' | MAX_SUBSCRIBERS | Not supported	RO
| '3' | DEPTH | Built-in depth sensor value, meters	RO
| '4' | TEMPERATURE | Built-in temperature sensor value, ˚C	RO
| '5' | BAT_CHARGE | Not supported	RO
| '6' | PRESSURE_RATING | Max. allowed hydrostatic pressure, bar	RO
| '7' | ZERO_PRESSURE | Pressure above water surface, bar	RW
| '8' | WATER_DENSITY | Water density[ Updates internally according to current temperature, pressure and salinity], kg/m3	RO
| '9' | SALINITY | Water salinity, ppm	RW
| '10' | SOUND_SPEED | Speed of sound[ Updates internally (if not set manually) according to current temperature, pressure and salinity], м/с	RW
| '11' | GRAVITY_ACC	Gravity acceleration[ Updates internally according to current geographic location (WGS-84 ellipsoid)] (g), m/s2	RO
| '12' | YEAR	Current year	RW
| '13' | MONTH	Current month	RW
| '14' | DATE	Current date	RW
| '15' | HOUR	Current hour	RO
| '16' | MINUTE	Current minute	RO
| '17' | SECOND	Current second[ Hour, minute and second updates from buoy's navigational signal]	RO
