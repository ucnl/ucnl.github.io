
[Главная](/README_RU) ❯ [Наши проекты для образования](/educational_projects_ru) ❯ **ACubes: Руководство пользователя**

<div style="page-break-after: always;"></div>

| ![logo](/documentation/sm_logo.png) | ![image](https://github.com/user-attachments/assets/f9be473c-561b-4536-8c0b-7ab44e6598aa) |
| :---: | ---: |
| [www.unavlab.com](https://www.unavlab.com/) <br/> [support@unavlab.com](mailto:support@unavlab.com) | **A<sup>3</sup>S** **ACubes** <br/> Руководство пользователя |


# Семейство устройств **A<sup>3</sup>S** <br/> Руководство пользователя

<div style="page-break-after: always;"></div>

## Содержание

- [0. Для кого и зачем эта коробка с кубиками?](#0-%D0%B4%D0%BB%D1%8F-%D0%BA%D0%BE%D0%B3%D0%BE-%D0%B8-%D0%B7%D0%B0%D1%87%D0%B5%D0%BC-%D1%8D%D1%82%D0%B0-%D0%BA%D0%BE%D1%80%D0%BE%D0%B1%D0%BA%D0%B0-%D1%81-%D0%BA%D1%83%D0%B1%D0%B8%D0%BA%D0%B0%D0%BC%D0%B8)
- [1. A<sup>3</sup>T и A<sup>3</sup>R](#1-a3t-%D0%B8-a3r)
  - [1.1. О гидроакустических антеннах](#11-%D0%BE-%D0%B3%D0%B8%D0%B4%D1%80%D0%BE%D0%B0%D0%BA%D1%83%D1%81%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D1%85-%D0%B0%D0%BD%D1%82%D0%B5%D0%BD%D0%BD%D0%B0%D1%85)
  - [1.2. Сценарий №1 - Передаем и принемаем](#12-%D1%81%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B9-1---%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D0%B5%D0%BC-%D0%B8-%D0%BF%D1%80%D0%B8%D0%BD%D0%B5%D0%BC%D0%B0%D0%B5%D0%BC)
    - [1.2.1. Требуемый набор оборудования](#121-%D1%82%D1%80%D0%B5%D0%B1%D1%83%D0%B5%D0%BC%D1%8B%D0%B9-%D0%BD%D0%B0%D0%B1%D0%BE%D1%80-%D0%BE%D0%B1%D0%BE%D1%80%D1%83%D0%B4%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F)
    - [1.2.2. Передатчик](#122-%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%82%D1%87%D0%B8%D0%BA)
       - [1.2.2.1. Скетч №1 - Инициация передачи 1 раз в секунду](#1221-%D1%81%D0%BA%D0%B5%D1%82%D1%87-1---%D0%B8%D0%BD%D0%B8%D1%86%D0%B8%D0%B0%D1%86%D0%B8%D1%8F-%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D0%B8-1-%D1%80%D0%B0%D0%B7-%D0%B2-%D1%81%D0%B5%D0%BA%D1%83%D0%BD%D0%B4%D1%83)
    - [1.2.3. Приемник](#123-%D0%BF%D1%80%D0%B8%D0%B5%D0%BC%D0%BD%D0%B8%D0%BA)
      - [1.2.3.1. Скетч №2 - Зажигаем светодиод по факту приема акустического сигнала](#1231-%D1%81%D0%BA%D0%B5%D1%82%D1%87-2---%D0%B7%D0%B0%D0%B6%D0%B8%D0%B3%D0%B0%D0%B5%D0%BC-%D1%81%D0%B2%D0%B5%D1%82%D0%BE%D0%B4%D0%B8%D0%BE%D0%B4-%D0%BF%D0%BE-%D1%84%D0%B0%D0%BA%D1%82%D1%83-%D0%BF%D1%80%D0%B8%D0%B5%D0%BC%D0%B0-%D0%B0%D0%BA%D1%83%D1%81%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B3%D0%BE-%D1%81%D0%B8%D0%B3%D0%BD%D0%B0%D0%BB%D0%B0)
  - [1.3. Кратко о многолучевости и защитных интервалах](#13-%D0%BA%D1%80%D0%B0%D1%82%D0%BA%D0%BE-%D0%BE-%D0%BC%D0%BD%D0%BE%D0%B3%D0%BE%D0%BB%D1%83%D1%87%D0%B5%D0%B2%D0%BE%D1%81%D1%82%D0%B8-%D0%B8-%D0%B7%D0%B0%D1%89%D0%B8%D1%82%D0%BD%D1%8B%D1%85-%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D0%B2%D0%B0%D0%BB%D0%B0%D1%85)
  - [1.4. Сценарий №2 - Собираем приемопередатчик и измеряем наклонную дальность](#14-%D1%81%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B9-2---%D1%81%D0%BE%D0%B1%D0%B8%D1%80%D0%B0%D0%B5%D0%BC-%D0%BF%D1%80%D0%B8%D0%B5%D0%BC%D0%BE%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%82%D1%87%D0%B8%D0%BA-%D0%B8-%D0%B8%D0%B7%D0%BC%D0%B5%D1%80%D1%8F%D0%B5%D0%BC-%D0%BD%D0%B0%D0%BA%D0%BB%D0%BE%D0%BD%D0%BD%D1%83%D1%8E-%D0%B4%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D1%8C)
    - [1.4.1. Требуемый набор оборудования](#141-%D1%82%D1%80%D0%B5%D0%B1%D1%83%D0%B5%D0%BC%D1%8B%D0%B9-%D0%BD%D0%B0%D0%B1%D0%BE%D1%80-%D0%BE%D0%B1%D0%BE%D1%80%D1%83%D0%B4%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F)
    - [1.4.2. Запрашивающее устройство](#142-%D0%B7%D0%B0%D0%BF%D1%80%D0%B0%D1%88%D0%B8%D0%B2%D0%B0%D1%8E%D1%89%D0%B5%D0%B5-%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%BE)
      - [1.4.2.1. Скетч №3 - Инициирует передачу и измеряет время между запросом и ответом](#1421-%D1%81%D0%BA%D0%B5%D1%82%D1%87-3---%D0%B8%D0%BD%D0%B8%D1%86%D0%B8%D0%B8%D1%80%D1%83%D0%B5%D1%82-%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D1%83-%D0%B8-%D0%B8%D0%B7%D0%BC%D0%B5%D1%80%D1%8F%D0%B5%D1%82-%D0%B2%D1%80%D0%B5%D0%BC%D1%8F-%D0%BC%D0%B5%D0%B6%D0%B4%D1%83-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%BE%D0%BC-%D0%B8-%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D0%BE%D0%BC)
    - [1.4.3. Маяк-ответчик. Вариант №1 - без Arduino](#143-%D0%BC%D0%B0%D1%8F%D0%BA-%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D1%87%D0%B8%D0%BA-%D0%B2%D0%B0%D1%80%D0%B8%D0%B0%D0%BD%D1%82-1---%D0%B1%D0%B5%D0%B7-arduino)
    - [1.4.4. Маяк-ответчик. Вариант №2 - с Arduino и фиксированной задержкой](#144-%D0%BC%D0%B0%D1%8F%D0%BA-%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D1%87%D0%B8%D0%BA-%D0%B2%D0%B0%D1%80%D0%B8%D0%B0%D0%BD%D1%82-2---%D1%81-arduino-%D0%B8-%D1%84%D0%B8%D0%BA%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D0%BE%D0%B9-%D0%B7%D0%B0%D0%B4%D0%B5%D1%80%D0%B6%D0%BA%D0%BE%D0%B9)
      - [1.4.4.1. Скетч №4 - Фиксированная задержка ответа](#1441-%D1%81%D0%BA%D0%B5%D1%82%D1%87-4---%D1%84%D0%B8%D0%BA%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D0%B0%D1%8F-%D0%B7%D0%B0%D0%B4%D0%B5%D1%80%D0%B6%D0%BA%D0%B0-%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D0%B0)     
    - [_1.5. (Планируется) Сценарий №3 - Определение положения ответчика методом виртуальной длинной базы_]()
      - [_1.5.1. (Планируется)Требуемый набор оборудования_]()
    - [_1.6. (Планируется) Сценарий №4 - Длиинобазисная навигационная система_]()
      - [_1.6.1. (Планируется)Требуемый набор оборудования_]()
      - [_1.6.2. (Планируется)Навигационный буй-приемник_]()
    - [_1.7. (Планируется) Сценарий №5 - Фазированная антенная решетка_]()
      - [_1.7.1. (Планируется)Требуемый набор оборудования_]()
- [_2. (Планируется)A<sup>3</sup>TC и A<sup>3</sup>RC_]()
- [_3. (Планируется)A<sup>3</sup>AM_]()



<div style="page-break-after: always;"></div>

## 0. Для кого и зачем эта коробка с кубиками?
В первую очередь ACubes задумывался для применения в сфере образования и подготовки инженерных кадров.

A³S (или ACubes, «Акустические кубики») — это конструктор, набор элементарных функциональных элементов, на основе которых можно создавать макеты практически любых типов гидроакустических навигационных систем и систем связи:

- простейшие системы передачи цифровой информации — гидроакустические модемы;
- системы для беспроводной передачи голоса;
- фазированные антенные решётки, а на их основе — ультракороткобазисные (USBL) навигационные системы с маяками-ответчиками;
- длиннобазисные, короткобазисные системы, а также системы с синтезированной измерительной базой;
- системы телеуправления;
- системы сетевого мониторинга.

«Кубики» берут на себя вопросы, связанные с преобразованием цифрового сигнала в гидроакустический и обратно, позволяя пользователю сосредоточиться на решении прикладных задач: разработке оригинальных навигационных алгоритмов, алгоритмов помехоустойчивого кодирования, сетевых протоколов и схем взаимодействия.

Как правило, для этих целей не требуются ни сверхминиатюрность, ни высокая мощность, ни рекордная дальность — важны простота, надёжность и доступность. Именно эти принципы мы заложили в основу при создании этой линейки устройств.

Мы сознательно не ограничиваем список самих «кубиков», поскольку он изначально задуман как пополняемый. Он будет расширяться в зависимости от сценариев применения — например, при сборке антенной решётки или приёмопередатчика для измерения наклонной дальности.

<div style="page-break-after: always;"></div>

## 1. A<sup>3</sup>T и A<sup>3</sup>R 
Это импульсный одноканальный (одночастотный) передатчик и одночастотный приёмник.

### Передатчик A³T
Передатчик [A³T](A3T_Datasheet_ru.md) излучает импульсы фиксированной частоты и длительности при изменении состояния на своём цифровом входе, которым управляет пользователь.

### Приёмник A³R
Приёмник [A³R](A3R_Datasheet_ru.md) может улавливать эти импульсы и передавать информацию пользователю, изменяя состояние своего цифрового выхода.

### Особенности работы
Эти два устройства спроектированы таким образом, что могут объединяться в стек и использовать общую приёмо-передающую антенну, например, [RT-1.332820-1](https://docs.unavlab.com/documentation/RU/Transducers/RT_1_332820_1_Specification_ru.html). В такой конфигурации получается приёмо-передатчик.

Если выход приёмника подключить ко входу передатчика, получится маяк-ответчик - принятый сигнал сразу же передаётся на вход передатчика, который излучает ответный гидроакустический сигнал. Вся связка работает по принципу "эха". Такая схема позволяет измерять, например, двойное время распространения сигнала между запрашивающим устройством и маяком-ответчиком, а следовательно, и наклонную дальность.

### Возможности масштабирования
Разъёмы, смонтированные по длинным краям плат, образуют шину, позволяющую объединить один передатчик и до 12 приёмников. При этом выходы всех приёмников будут доступны на свободном разъёме.

Таким образом можно строить и изучать различные конфигурации антенных решёток. Если 12-элементной антенной решётки недостаточно, можно использовать любое количество стеков, в каждом из которых может быть до 12 модулей [A³R](A3R_Datasheet_ru.md).

Для удобного объединения до 24 приёмников существует специальная кросс-плата [A³R-CB2](). Естественно, можно использовать любое количество таких плат.

### 1.1. О гидроакустических антеннах

Для работы с модулями **A³S** доступны антенны двух типов:
1. **Приёмо-передающие** - совместимы как с модулями [A³R](A3R_Datasheet_ru.md), так и с [A³T](A3T_Datasheet_ru.md)
2. **Приёмные** - предназначены исключительно для работы с модулями [A³R](A3R_Datasheet_ru.md)

#### Особенности выбора антенн
При использовании устройства только в режиме приёма рекомендуется выбирать приёмные антенны, так как они:
- имеют более низкую стоимость
- отличаются меньшими габаритами и массой

#### Специализированные приёмные антенны
Антенны серии [R-1.d3505-1](/documentation/RU/Transducers/R_1.d3505_1_Specification_ru.md):
- разработаны специально для модулей A³R
- оснащены специальными креплениями
- оптимальны для построения антенных решёток при многоканальном приёме

| ![image](https://github.com/user-attachments/assets/850006dd-7430-472e-9dc8-82bf3dfe48e2) |
| :---: |
| |

#### Приёмо-передающие антенны
Лаборатория подводной связи и навигации предлагает несколько моделей:

| Модель | Характеристики |
|--------|----------------|
| [RT-1.332820-1](/documentation/RU/Transducers/RT_1_332820_1_Specification_ru.md) | Наиболее доступное и компактное решение |
| [RT-2.332820-1](/documentation/RU/Transducers/RT_2_332820_1_Specification_ru.html) | Свешиваемая антенна для надводного оборудования (2 пьезоэлемента) |
| [RT-1.524525-1](/documentation/RU/Transducers/RT-1.524525-1_specification_ru.html) | Модель с повышенной чувствительностью |

#### Правила эксплуатации
1. **Механическая защита**:
   - Избегайте ударных нагрузок
   - Не допускайте неравномерного нагружения
   - Антенны с крепёжным пазом должны фиксироваться только за него
   - Запрещается перекрывать рабочую поверхность антенны

2. **Электрическая безопасность**:
   - Перед подключением снимайте возможный заряд (закорачивайте выводы)

3. **Уход и обслуживание**:
   - Не используйте агрессивные растворители (ацетон, изопропанол)
   - Особенно осторожно обращайтесь с полиуретановыми покрытиями

При соблюдении этих правил антенны демонстрируют долговечность и простоту в обслуживании.

### 1.2. Сценарий №1 - Передаем и принимаем
Самый простой сценарий, в котором задействованы один приёмник и один передатчик.

#### 1.2.1. Требуемый набор оборудования

| № | Наименование | Количество | Примечание |
|---|--------------|------------|------------|
| 1 | Модуль [A³R](A3R_Datasheet_ru.md) | 1 | |
| 2 | Модуль [A³T](A3T_Datasheet_ru.md) | 1 | |
| 3 | Антенна приёмная [R-1.d3505-1](/documentation/RU/Transducers/R_1.d3505_1_Specification_ru.md) | 1 | |
| 4 | Антенна приёмо-передающая [RT-1.332820-1](/documentation/RU/Transducers/RT_1_332820_1_Specification_ru.md) | 1 | |
| 5 | Плата с микроконтроллером (например, Arduino Nano) | 2 | Можно заменить кнопкой для инициации передачи |
| 6 | Провода Dupont Female-Female или Male-Female, 25+ см | 4 | |

#### Подключение антенн
1. Подключите приёмную антенну [R-1.d3505-1](/documentation/RU/Transducers/R_1.d3505_1_Specification_ru.md) к модулю [A³R](A3R_Datasheet_ru.md):

| ![image](https://github.com/user-attachments/assets/7cedae37-16d1-4a18-8254-a32e16ff09b4) |
| :---: |
| |

2. Подключите приёмо-передающую антенну [RT-1.332820-1](/documentation/RU/Transducers/RT_1_332820_1_Specification_ru.md) к модулю [A³T](A3T_Datasheet_ru.md):

| ![image](https://github.com/user-attachments/assets/c3f2d99a-9efd-4d3a-8e49-2add970014aa) |
| :---: |
| |

#### 1.2.2. Настройка передатчика

##### Принцип работы:
- Инициация передачи осуществляется изменением логического уровня на пине 4 (разъём XS2)
- Необходимо перевести пин из высокого состояния (HIGH) в низкое (LOW)
- Для этого соедините пин 4 с любым нечётным пином GND на том же разъёме

##### Схема подключения к Arduino Nano:

| Контакт на XS2 | Контакт на Arduino Nano |
|----------------|-------------------------|
| 1 (GND) | GND |
| 4 (Инициация передачи) | 10 (D10) |

##### Скетч для передачи (1 импульс в секунду):

```c
#define TX_PIN 4       // Пин инициации передачи
#define LED_PIN 13     // Индикаторный светодиод

void setup() {
  pinMode(TX_PIN, OUTPUT);
  pinMode(LED_PIN, OUTPUT);
  digitalWrite(TX_PIN, HIGH); // Исходное состояние
}

void loop() {
  digitalWrite(TX_PIN, LOW);  // Начало передачи
  digitalWrite(LED_PIN, HIGH);
  delay(10);                 // Длительность импульса 10 мс
  
  digitalWrite(TX_PIN, HIGH); // Окончание передачи
  digitalWrite(LED_PIN, LOW);
  delay(990);                // Общий период 1 секунда
}
```

*Примечание: минимальный интервал между передачами - 40 мс*

#### 1.2.3. Настройка приёмника

##### Принцип работы:
- При обнаружении сигнала модуль переводит пин 1 (XS3) в состояние LOW на 2 мс
- Для детектирования можно использовать Arduino или осциллограф

##### Схема подключения к Arduino Nano:

| Контакт на XS3 | Контакт на Arduino Nano |
|----------------|-------------------------|
| 2 (GND) | GND |
| 1 (Строб приёма) | 2 (D2) |

##### Скетч для приёма:

```c
#define RX_PIN 2       // Пин детектирования приёма
#define LED_PIN 13     // Индикаторный светодиод

void setup() {
  pinMode(RX_PIN, INPUT);
  pinMode(LED_PIN, OUTPUT);
  attachInterrupt(digitalPinToInterrupt(RX_PIN), rxDetected, FALLING);
}

void rxDetected() {
  digitalWrite(LED_PIN, HIGH);
  delay(100);         // Светодиод горит 100 мс при приёме
  digitalWrite(LED_PIN, LOW);
}

void loop() {
  // Основной цикл не требуется
}
```

#### 1.2.4. Тестирование системы

1. **На воздухе**:
   - Разместите антенны на расстоянии 10-15 см друг от друга
   - При успешной передаче светодиоды на обеих платах Arduino будут синхронно мигать

2. **В водной среде**:
   - Обеспечьте заглубление антенн не менее 1 метра от поверхности
   - Избегайте пузырей воздуха возле рабочих поверхностей антенн

| ![image](https://github.com/user-attachments/assets/76dd271a-f87e-45c2-bbad-dad94bc4ccd2) |
| :---: |
| |

### 1.3. Кратко о многолучевости и защитных интервалах

Многолучевость и методы борьбы с ней представляют собой обширную область исследований. В данном разделе мы рассмотрим лишь основные принципы.

#### 1.3.1. Суть явления многолучевости

Явление многолучевости можно сравнить с акустическим эхом. Звуковой сигнал от источника распространяется сферическим фронтом, при этом:

1. **Прямой луч** - кратчайший путь от источника к приёмнику
2. **Отражённые лучи** - сигналы, отразившиеся от:
   - Дна водоёма
   - Поверхности воды
   - Подводных объектов
3. **Преломлённые лучи** - сигналы, изменившие направление из-за:
   - Неоднородностей водной среды
   - Изменения скорости звука на разных глубинах

#### 1.3.2. Проблемы, вызванные многолучевостью

1. **Ошибки измерения**:
   - Ложное определение наклонной дальности

2. **Эффект "эхо-петли"**:
   - В системах маяков-ответчиков возможно возникновение бесконечного цикла "запрос-ответ"
   - Особенно критично при использовании одной частоты для передачи и приёма

#### 1.3.3. Методы борьбы (на примере ACubes)

Для простых сигнальных систем наиболее эффективным решением является **защитный интервал**:

| Параметр | Описание |
|----------|----------|
| Принцип работы | После детектирования сигнала приёмник временно прекращает анализ входящих сигналов |
| Длительность | Определяется экспериментально для конкретных условий |
| Факторы влияния | Глубина, рельеф дна, наличие объектов, свойства водной среды |

**Рекомендации по настройке:**
1. Начинайте с интервала 50-100 мс для небольших акваторий
2. Постепенно увеличивайте интервал до исчезновения ложных срабатываний
3. Для точных измерений проводите калибровку в рабочих условиях

*Примечание: В профессиональных системах используются более сложные методы (разнесённые частоты, кодирование сигналов, адаптивные алгоритмы), но они выходят за рамки данного руководства.*

Вот исправленный и отформатированный текст с исправленными примерами кода:

### 1.4. Сценарий №2 - Собираем приемопередатчик и измеряем наклонную дальность

В ходе данной работы мы соберем два приемопередатчика, один из которых будет выполнять функцию маяка-ответчика, а другой сможет излучать запросный сигнал, ожидать ответный и по времени распространения сигнала и скорости звука определять наклонную дальность между абонентами.

#### 1.4.1. Требуемый набор оборудования

| №    | Наименование | Количество | Примечание |
| :--- | :--- | :--- | :--- |
| 1    | Модуль [A<sup>3</sup>R](A3R_Datasheet_ru.md) | 2 |  |
| 2    | Модуль [A<sup>3</sup>T](A3T_Datasheet_ru.md) | 2 |  |
| 3    | Антенна приемопередающая [RT-1.332820-1](/documentation/RU/Transducers/RT_1_332820_1_Specification_ru.md) | 2 |  |
| 4    | Любая плата с МК, например, Arduino Nano | 2 |  |
| 5    | LCD-экран, например MT-204S | 1 | Для отображения измеренного времени и дальности, но можно выводить и в COM-порт |
| 6    | Провода Dupont Female-Female или Male-Female, 25+ см | 15 | |

На самом деле данный сценарий содержит как минимум два разных подсценария:  
**первый** подразумевает установку перемычки **P0** на маяке-ответчике, таким образом, чтобы выход приемника был соединен со входом передатчика. И маяк-ответчик в этом случае будет излучать ответный сигнал с нулевой задержкой. Казалось бы, схема наиболее удобная и максимально простая, но такой подход накладывает определенные ограничения. Дело в том, что у приемных модулей есть т.н. защитный интервал, который определяет, через какое время после приема возможен следующий прием. В свою очередь это означает, что у такой системы будет некоторая минимальная дальность, расстояние меньше которой измерить не получится - в момент прихода ответного сигнала с расстояния, меньше минимального, приемник будет ожидать завершения защитного интервала и будет невосприимчив.

Во **втором** подсценарии мы вводим фиксированную задержку между приемом запросного сигнала и излучением ответа. Значение этой задержки известно на запрашивающем устройстве и может быть легко учтено. Такая схема хоть и сложнее, но позволяет измерять расстояния почти до нулевого. Для формирования этой задержки удобнее всего воспользоваться каким-нибудь МК, например, той же Arduino.

Итак, начнем с запрашивающего устройства. Опять же, мы подготовили два варианта разной сложности - с использованием экрана и без - с передачей необходимой информации по UART.

#### 1.4.2. Запрашивающее устройство
Сначала соберем "бутерброд" из модулей A<sup>3</sup>R и A<sup>3</sup>T. Зададим адрес приемника на шине, установив джампер P1. Это сделано для того, чтобы все подключение к плате Arduino было на разъеме XS2. Оплетку и минус антенны спаиваем вместе. Платы приемника и передатчика соединяем перемычками из отрезков проводов через разъемы XS1.

| ![image](https://github.com/user-attachments/assets/d4376f61-762a-4d25-8e14-e6fb466bdc52) |
| :---: |
| |

Далее, подключаем сборку кубиков к плате Arduino. Для этого потребуется 4 провода папа-мама.

| ![image](https://github.com/user-attachments/assets/af9ca034-c4bb-451c-ab49-99c504a420cf) |
| :---: |
| |

| Номер/Наименование контакта на XS2 | Номер/Наименование контакта на Arduino Nano |
| :--- | :--- |
| 1 / GND  | GND |
| 2 / Строб при начале передачи | 3 / INT1 |
| 4 / Инициация передачи импульса | 10 |
| 6 / Строб приемника №1 | 2 / INT0 |

Если вы планируете использовать LCD-экран МЭЛТ МТ-20S4S или совместимый, то необходимо соединить пины следующим образом:

| Номер контакта на экране | Номер/Наименование контакта на Arduino Nano|
| :--- | :--- |
| 1 | GND |
| 2 | 5V |
| 4 | 8 (D8) |
| 5 | 9 (D9) |
| 10 | 4 (D4) |
| 11 | 5 (D5) |
| 12 | 6 (D6) |
| 13 | 7 (D7) |

Кроме того, необходимо на плате экрана соединить контакты 1-5 и 2-18, а также контакты 2-3 между собой. Сопротивление между контактами 2-3 задает контрастность экрана, и в некоторых случаях простого их замыкания может оказаться недостаточно. 

Ниже представлен скетч для управляющей платы Arduino:

##### 1.4.2.1. Скетч №3 - Инициирует передачу и измеряет время между запросом и ответом
Если использование экрана не планируется, необходимо закомментировать строчку `#define USE_LCD`. Скорость звука задана константой 1500.0, для более точного значения предлагаем обратиться к нашему онлайн-калькулятору скорости звука в воде: [Толковый калькулятор скорости звука в воде](https://docs.unavlab.com/online_utils/proper_speed_of_sound_calculator.html)

```с
#define USE_LCD

#ifdef USE_LCD
#include <LiquidCrystal.h>
LiquidCrystal lcd(8, 9, 4, 5, 6, 7); // RS, E, D4-D7
#define X_MAX              (20) // Число символов на строчку экрана
#define MSG_LINE           (1)  // Номер строки для сообщения
#define W_LINE             (0)  // Номер строки для отображения прогресса
int c_idx = 0;
#endif

#define A3R_STATE_PIN      (2)  // Пин, куда заводится строб от приемника
#define A3T_STATE_PIN      (3)  // Пин, куда заводится строб от передатчика
#define A3T_TX_ENGAGE_PIN  (10) // Пин, управляющий началом передачи на модуле передатчика

#define TKS_PER_S          (1000000L) // Число микросекунд в одной секунде на плате Arduino Nano

#define RX_DT_MS           (80L) // Защитный интервал для отсеивания сигнала локального передатчика, [мс]
#define RX_DT_TKS          (RX_DT_MS * 1000L)

#define ANSWER_DELAY_MS    (100L) // Фиксированная задержка ответа на ответчике, [мс]
#define ANSWER_DELAY_TKS   (ANSWER_DELAY_MS * 1000L)

#define SOS_MPS            (1500.0) // Скорость звука, [м/с]
#define MAX_DIST_M         (500L)   // Максимальная дальность, м

#define TIMEOUT_TKS        (ANSWER_DELAY_TKS + (long)(TKS_PER_S * (MAX_DIST_M * 2) / SOS_MPS)) // Длительность интервала ожидания ответа
#define STATE_TIMEOUT_TKS  (TIMEOUT_TKS * 3)                                              
#define TKS_PER_CHAR       ((TIMEOUT_TKS) / (X_MAX))

volatile int      state = 0; // Состояние
volatile uint32_t tks;       // Переменная для текущего времени, [мкс]
volatile uint32_t tot;       // Time of Transaction start, время начала транзакции, [мкс]
volatile uint32_t tor;       // Time of Radiation start - время начала излучения запросного сигнала, [мкс]
volatile uint32_t toa;       // Time of arrival - момент прихода ответного сигнала, [мкс]

float    tof; // Time of flight - переменная для времени распространения
float    srn; // Slant range - наклонная дальность

void a3t_state_changed_interrupt_handler() {
  tor = micros();
  digitalWrite(A3T_TX_ENGAGE_PIN, HIGH);
  state = 2;
}

void a3r_state_changed_interrupt_handler() {
  if (state == 3) {
    toa = micros();
    state = 4;
  }
}

void setup() {
#ifdef USE_LCD
  lcd.begin(20, 4);
  lcd.clear();
#endif

  Serial.begin(9600);

  pinMode(A3T_TX_ENGAGE_PIN, OUTPUT);
  digitalWrite(A3T_TX_ENGAGE_PIN, HIGH);

  pinMode(A3T_STATE_PIN, INPUT);
  attachInterrupt(digitalPinToInterrupt(A3T_STATE_PIN), a3t_state_changed_interrupt_handler, FALLING);

  pinMode(A3R_STATE_PIN, INPUT);
  attachInterrupt(digitalPinToInterrupt(A3R_STATE_PIN), a3r_state_changed_interrupt_handler, FALLING);
}

void loop() {  
  switch (state) {
    case 0: 
      state = 1;
      tot = micros();
    
#ifdef USE_LCD
      lcd.setCursor(0, W_LINE);
      lcd.print("                    ");
      
      digitalWrite(A3T_TX_ENGAGE_PIN, LOW);
#endif
    break;

    case 1:
      // Ожидание изменения состояния
    break;

    case 2:
      tks = micros();
      if (tks - tor > RX_DT_TKS)
        state = 3;
    break;

    case 3:
      tks = micros();

      if (tks - tor > TIMEOUT_TKS) {
#ifdef USE_LCD
        lcd.setCursor(0, MSG_LINE);
        lcd.print("      TIMEOUT       ");
#endif

        Serial.print("TIMEOUT\r\n");
        state = 5;
      } else {
#ifdef USE_LCD
        c_idx = (int)((tks - tor)/TKS_PER_CHAR);
        if (c_idx > 20) 
          c_idx = 20;
        lcd.setCursor(c_idx, W_LINE);
        lcd.print(")");
#endif
      }
    break;

    case 4:
      tof = (int32_t)(toa - tor) - (int32_t)ANSWER_DELAY_TKS;
      tof /= 2.0;
      tof /= (float)TKS_PER_S;
      srn = tof * SOS_MPS;

#ifdef USE_LCD
      lcd.setCursor(0, MSG_LINE);
      lcd.print("                    ");
      lcd.setCursor(0, MSG_LINE);
      lcd.print(srn, 1);    
      lcd.print(" m");
#endif

      Serial.println(srn, 1);
      state = 5;
    break;
    
    case 5:
      // Ожидание таймаута для следующего измерения
    break;
  }

  tks = micros();
  if (tks - tot > STATE_TIMEOUT_TKS) {
    state = 0;
  }
}
```

#### 1.4.3. Маяк-ответчик. Вариант №1 - без Arduino
Здесь нам необходимо собрать такой же "бутерброд", как и для запрашивающего устройства, с тем лишь отличием, что мы устанавливаем джампер **P0**, который замыкает выход приемника и вход передатчика. Строб от приемника при получении сигнала станет стробом, инициирующим передачу. Также не забудем установить джампер для задания адреса приемника на шине - это позволит вывести его на разъем XS2.

| ![image](https://github.com/user-attachments/assets/4f5f288b-7dd7-45a7-bfdb-2fee609555d9) |
| :---: |
| |

Антенну подключаем таким же образом, как и для запрашивающего устройства: оплетка и минус спаяны, перемычками соединены разъемы XS1 приемника и передатчика. 
Отметим, что питание и в случае запрашивающего устройства, и в случае маяка-ответчика необходимо подавать на передающий модуль, чтобы избежать прохождения существенных токов по шине в момент излучения.

#### 1.4.4. Маяк-ответчик. Вариант №2 - с Arduino и фиксированной задержкой
В этом случае в скетче для Arduino запрашивающего устройства необходимо задать какое-то ненулевое значение `ANSWER_DELAY_MS`. И у платы приемника, и у платы передатчика длительность защитного интервала составляет 40 мсек. Соответственно, выбираемая длительность фиксированной задержки должна быть больше этого значения. 

Кроме изменения значения `ANSWER_DELAY_MS` в скетче запрашивающего устройства не потребуется никаких изменений. А к маяку-ответчику теперь необходимо убрать джампер **P0** и подключить вторую плату Arduino Nano, согласно следующей таблице:

| Номер/Наименование контакта на XS2 | Номер/Наименование контакта на Arduino Nano |
| :--- | :--- |
| 1 / GND  | GND |
| 4 / Инициация передачи импульса | 10 |
| 6 / Строб приемника №1 | 2 / INT0 |

Вот так может выглядеть незамысловатый скетч, который ожидает приема сигнала, выдерживает паузу и излучает ответный сигнал:

##### 1.4.4.1. Скетч №4 - Фиксированная задержка ответа
  
```с
#define A3R_STATE_PIN     (2)
#define A3T_TX_ENGAGE_PIN (10)
#define LED_PIN           (13)

#define ANSWER_DELAY_MS    (100L) // Фиксированная задержка ответа на ответчике, [мс]
#define DEAD_TIME_MS       (100L) // Защитный интервал после излучения

#define TX_STROBE_DURATION_MS  (10L)

void setup() {
  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, LOW);

  pinMode(A3T_TX_ENGAGE_PIN, OUTPUT);
  digitalWrite(A3T_TX_ENGAGE_PIN, HIGH);

  pinMode(A3R_STATE_PIN, INPUT_PULLUP);
}

void loop() {
  if (digitalRead(A3R_STATE_PIN) == LOW) {
    delay(ANSWER_DELAY_MS);
    digitalWrite(A3T_TX_ENGAGE_PIN, LOW);
    digitalWrite(LED_PIN, HIGH);
    delay(TX_STROBE_DURATION_MS);
    digitalWrite(A3T_TX_ENGAGE_PIN, HIGH);
    delay(DEAD_TIME_MS);
    digitalWrite(LED_PIN, LOW);    
  }
}
```

<div style="page-break-after: always;"></div>
