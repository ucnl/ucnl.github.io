[Главная](/README_RU) ❯ [Гидроакустические навигационные и трекинговые системы](/navigation_and_tracking_systems_ru) ❯ **Zima2 USBL: Протокол информационного сопряжения**

<div style="page-break-after: always;"></div>

| ![logo](/documentation/sm_logo.png) |  |
| :---: | ---: |
| [www.unavlab.com](https://www.unavlab.com/) <br/> [support@unavlab.com](mailto:support@unavlab.com) | **Zima2 USBL** - гидроакустическая навигационная система <br/> Протокол информационного сопряжения |

# Zima2 USBL <br/> Протокол информационного сопряжения

<div style="page-break-after: always;"></div>

## Содержание
- [1. Введение](#1-%D0%B2%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5)  
  - [1.1. Протокол физического уровня](#11-%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%BB-%D1%84%D0%B8%D0%B7%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B3%D0%BE-%D1%83%D1%80%D0%BE%D0%B2%D0%B5%D0%BD%D1%8F)
  - [1.2. Стандарт протокола диалогового уровня NMEA0183](#12-%D1%81%D1%82%D0%B0%D0%BD%D0%B4%D0%B0%D1%80%D1%82-%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%BB%D0%B0-%D0%B4%D0%B8%D0%B0%D0%BB%D0%BE%D0%B3%D0%BE%D0%B2%D0%BE%D0%B3%D0%BE-%D1%83%D1%80%D0%BE%D0%B2%D0%BD%D1%8F-nmea0183)
- [2. Система команд AZM](#2-%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0-%D0%BA%D0%BE%D0%BC%D0%B0%D0%BD%D0%B4-azm)  
   - [2.1. IC_D2H_ACK - реакция устройства](#21-ic_d2h_ack)
     
- [3. Таблицы идентификаторов](#3-%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D1%8B-%D0%B8%D0%B4%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%D0%BE%D1%80%D0%BE%D0%B2)
  


<div style="page-break-after: always;"></div>

## 1. Введение
### 1.1. Протокол физического уровеня

Устройства системы [Zima2 USBL](Zima2_DataBrief_ru.md) поддерживают информационное сопряжение при помощи стандарта физического уровня RS-232 
для асинхронного интерфейса (UART) c напряжением линии данных 3.3В. Подключение производится при помощи четырехпроводного кабеля, с жилами Tx
(трансмиттер), Rx (ресивер), Vcc (питание) и GND (земля). Без применения дополнительных повторителей и преобразователей интерфейса 
максимальная длинна шины данных, для которой гарантируется корректная работа интерфейса, составляет не более 2 метров.

Настройки порта подключения по умолчанию<sup>[1](#footnote1)</sup>:  

| Парметр | Значение |
| :--- | :--- |
| Baudrate | 9600 bit/s |
| Data bits | 8 |
| Stop bits | 1 |  
| Parity | No |
| Hardware flow control | No |  

>**ВНИМАНИЕ!**
>_У устройств без преобразователей интерфейса напряжение линии данных составляет 3.3 В._

### 1.2. Стандарт протокола диалогового уровня NMEA0183
Стандарт NMEA0183 описывает формат текстовых (ASCII) сообщений диалогового уровня.  

Пример сообщения:  
**`
$PAZM0,,0*06<СR><LF>
`**  

Основные элементы посылки (сообщения, sentence) NMEА0183:

| Элемент | Описание |
| :--- | :--- |
| $ | начало сообщения |
| P | Proprietary, проприетарный код |
| AZM | трехбуквенный идентификатор |
| 0 | идентификатор сообщения |
| | первый параметр - пустой |
| , | запятая (разделитель параметров) |
| 0 | второй параметр имеет значение '0' |
| \* | разделитель контрольной суммы |
| 06 | контрольная сумма в шестнадцатеричном формате (например FF, 01). [Рассчитывается](https://docs.unavlab.com/online_utils/nmea0183_checksum_calculator.html) как побитовый XOR всех байт между '$' и '\*'. |
| <CR\><LF\> | конец сообщения (перевод строки) |

Формат вышеприведенного сообщения описывается следующим образом:
**`
$PAZM0,[x],x*06<СR><LF>
`**

x - означает целочисленный параметр, квадратные скобки '[]' - говорят о том, что параметр может быть пустым.
Ниже представлен список возможных дескрипторов параметров:

| Дескриптор | Описание |
| :--- | :--- |
| x | Целочисленное значение |
| xx | Целочисленное значение занимающее ровно два символа: от 00 до 99 |
| x.x | Вещественное значение |
| c--c | Строка символов |
| hh | шестнадцатеричное значение от 00 до FF |

________
<a name="footnote1"><sup>1</sup> Указанные параметры могут быть изменены по запросу</a>

<div style="page-break-after: always;"></div>

## 2. Система команд AZM
Префикс **D2H** в наименовании сообщений означает, что оно передается от устройства (Device) к управляющей системе (Host).
Префикс **H2D** в наименовании сообщений означает, что оно передается от управляющей системы (Host) к устройству (Device).
Префикс **D2D** в наименовании сообщений означает, что оно может передаваться в обе стороны: как от устройства к управляющей системе, так и наоборот.

### 2.1. D2H_ACK
Сообщение D2H_ACK - реакция устройства на поступивший от управляющей системы запрос.  

Формат сообщения: 
**`
$PAZM0,[x],x*hh<CR><LF>
`**

| № | Поле/параметр | Описание |
| :--- | :--- | :--- |
| | $	| начало сообщения '$' |
| | PAZM | система команд AZM |
| | 0	| идентификатор сообщения |
| 1 | cmdID | Идентификатор команды, на которую устройство отреагировало |
| 2 | result | Код ошибки \([см. 3.2.]()\) |
| | *	| разделитель контр. суммы NMEA |
| | hh | контрольная сумма NMEA |
| | \<CR\>\<LF\> | конец сообщения |

### 2.2. D2D_STRSTP
Сообщение D2D_STRSTP - сообщение для задания параметров запроса маяков-ответчиков.

Передается от управляющей системы к пеленгационной станции для:
- начала опроса маяков-ответчиков
- останова опроса маяков-ответчиков
- изменения параметров опроса (маски адресов, максимальной дистанции, солености воды)

Передается от пеленгационной станции к управляющей системе как эхо-подтверждение о принятии команды. Если команда не принимается устройством, то оно сообщает об этом при помощи команды [2.1. D2H_ACK]() с соответствущим кодом ошибки.

Формат сообщения: 
**`
$PAZM1,[x],[x.x],[x.x],[x]*hh<CR><LF>
`**

| № | Поле/параметр | Описание |
| :--- | :--- | :--- |
| | $	| начало сообщения '$' |
| | PAZM | система команд AZM |
| | 1	| идентификатор сообщения |
| 1 | addrMask | Маска адреса маяков для опроса, 16-битное цело беззнаковое число, каждый бит от 0 до 15 соответствует одному из маяков, бит = 0 - маяк не учавствует в опросе, бит = 1 - маяк участвует в опросе. Если параметр пустой или равен нулю, то опрос не останавливается. |
| 2 | sty_PSU | Соленость воды в PSU в диапазоне от 0 до 40. Если параметр пустой, используется значение по умолчанию (0 PSU) |
| 3 | soundSpeed_mps | Скорость звука в воде в м/с в диапазоне от 1350 до 1600 м/с. Если параметр пустой, скорость звука будет рассчитываться автоматически на основе данных о солености, температуре и давлении |
| 4 | max_dist_m | Максимальная дальность в метрах в диапазоне от 500 до 5500. По данному параметру рассчитывается максимальный интервал ожидания ответа маяка. |
| | *	| разделитель контр. суммы NMEA |
| | hh | контрольная сумма NMEA |
| | \<CR\>\<LF\> | конец сообщения |


### 2.3. D2D_RSTS
Сообщение D2D_RSTS - сообщение для задания настроек маяков-ответчиков.

Передается от управляющей системы к маяку-ответчику для задания его адреса и солености воды.
Передается от маяка-ответчика к управляющей системе как эхо-подтверждение о принятии команды и установке параметров.
Если команда не принимается устройством, то оно сообщает об этом при помощи команды [2.1. D2H_ACK]() с соответствущим кодом ошибки.

Формат сообщения: 
**`
$PAZM2,[x],[x.x]*hh<CR><LF>
`**

| № | Поле/параметр | Описание |
| :--- | :--- | :--- |
| | $	| начало сообщения '$' |
| | PAZM | система команд AZM |
| | 2	| идентификатор сообщения |
| 1 | addr | Адрес маяка в диапазоне от 0 до 15. Если параметр пустой, то адрес не изменяется. |
| 2 | sty_PSU | Соленость воды в PSU в диапазоне от 0 до 40. Если параметр пустой, используется значение по умолчанию (0 PSU) |
| | *	| разделитель контр. суммы NMEA |
| | hh | контрольная сумма NMEA |
| | \<CR\>\<LF\> | конец сообщения |


### 2.4. D2H_NDTA
Сообщение D2H_NDTA - статус пеленгационной станции.

Это основное сообщение, передающееся от пеленгационной станции к управляющей системе. При помощи него станция сообщает:
- значения локальных парметров: температура, давление, крен, дифферент
- параметры принятого от маяка-ответчика ответа: адрес маяка, время распространения сигнала, наклонная дальность и ее проекция, глубина, горизонтальный и вертикальный углы, код ошибки, качество связи
- превышение интервала ожидания ответа маяка (таймаут)

Формат сообщения: 
**`
$PAZM3,x,[x],[x],[x],[x.x],[x.x],[x.x],[x.x],[x.x],[x.x],[x.x],[x.x],[x.x],[x.x],[x.x],[x.x]*hh<CR><LF>
`**

| № | Поле/параметр | Описание |
| :--- | :--- | :--- |
| | $	| начало сообщения '$' |
| | PAZM | система команд AZM |
| | 3	| идентификатор сообщения |
| 1 | status | Статус сообщения: 0 - Только локальные параметры, 1 - ответ маяка, 2 - таймаут |
| 2 | addr | Адрес маяка в диапазоне от 0 до 15. Параметр пустой для сообщений с полем 'status' содержащим '0' (Только локальные параметры) |
| 3 | rq_code | Идентификатор запрошенного у маяка параметра. [См. таблицу 3.2. Идентификаторы запросов]() |
| 4 | rs_code | Код ответа маяка [См. таблицу 3.3. Коды ответа маяков]() |
| 5 | msr_dB | Параметр, определяющий качество приема ответного сигнала маяка в dB. 14 - порог приема, значения выше 20 dB означают хорошие условия связи |
| 6 | p_time_s | Время распростренения сигнала в секундах. Умноженное на значение скорости звука дает наклонную дальность |
| 7 | s_range_m | Наклонная дальность от пеленгационной антенны до маяка в метрах |
| 8 | p_range_m | Проекция наклонной дальности от пеленгационной антенны до маяка на водную поверхность в метрах |
| 9 | r_dpt_m | Абсолютное значение глубины маяка-ответчика в метрах |
| 10 | a_deg | Горизонтальный угол прихода сигнала маяка-ответчика в градусах. Отсчитывается от нулевого направления пеленгационной антенны по часовой стрелке со стороны кабеля |
| 11 | e_deg | Вертикальный угол прихода сигнала маяка-ответчика в градусах. Отсчитывается от горизонтальной плоскости, проходящей через антенную решетку |
| 12 | lprs_mBar | Абсолютное давление в миллибарах по данным встроенного датчика пеленгационной антенны |
| 13 | ltmp_C | Температура в °С по данным встроенного датчика пеленгационной антенны |
| 14 | lhdn_deg | Параметр не используется, зарезервирован для будущих применений |
| 15 | lptc_deg | Угол дифферента пеленгационной антенны. Отсчитывается от вертикали, положительные значения - крен на нос (в сторону нулевого направления антенны), отрицательные - крен на корму |
| 16 | lrol_deg | Угол крена пеленгационной антенны. Отсчитывается от вертикали, положительные значения - на правый борт (относительно нулевого направления антенны), отрицательные значения - на левый борт |
| | *	| разделитель контр. суммы NMEA |
| | hh | контрольная сумма NMEA |
| | \<CR\>\<LF\> | конец сообщения |






<div style="page-break-after: always;"></div>

## 3. Таблицы идентификаторов



<div style="page-break-after: always;"></div>
