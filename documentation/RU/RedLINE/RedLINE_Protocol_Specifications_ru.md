| ![logo](/documentation/sm_logo.png) |  |
| :---: | ---: |
| [www.unavlab.com](https://www.unavlab.com/) <br/> [support@unavlab.com](mailto:support@unavlab.com) | **RedLINE** - семейство устройств гидроакустической связи <br/> Протокол информационного сопряжения |
  
  
  
# RedLINE <br/> протокол информационного сопряжения

<div style="page-break-after: always;"></div>

## Содержание
- [1. Введение](#1-%D0%B2%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5)  
  - [1.1. Протокол физического уровня](#11-%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%BB-%D1%84%D0%B8%D0%B7%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B3%D0%BE-%D1%83%D1%80%D0%BE%D0%B2%D0%B5%D0%BD%D1%8F)
  - [1.2. Стандарт протокола диалогового уровня NMEA0183](#12-%D1%81%D1%82%D0%B0%D0%BD%D0%B4%D0%B0%D1%80%D1%82-%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%BB%D0%B0-%D0%B4%D0%B8%D0%B0%D0%BB%D0%BE%D0%B3%D0%BE%D0%B2%D0%BE%D0%B3%D0%BE-%D1%83%D1%80%D0%BE%D0%B2%D0%BD%D1%8F-nmea0183)
- [2. Система команд TNT для ГА модемов RedLINE](#2-%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0-%D0%BA%D0%BE%D0%BC%D0%B0%D0%BD%D0%B4-tnt-%D0%B4%D0%BB%D1%8F-%D0%B3%D0%B0-%D0%BC%D0%BE%D0%B4%D0%B5%D0%BC%D0%BE%D0%B2-redline)  
   - [2.1. IC_D2H_ACK - реакция устройства](#21-ic_d2h_ack)
   - [2.2. IC_H2D_LOC_DATA_GET](#22-ic_h2d_loc_data_get)
   - [2.3. IC_D2H_LOC_DATA_VAL](#23-ic_d2h_loc_data_val)
   - [2.4. IC_H2D_SETTINGS_WRITE](#24-ic_h2d_settings_write)
   - [2.5. IC_H2D_SETTINGS_READ](#25-ic_h2d_settings_read)
   - [2.6. IC_D2H_SETTINGS](#26-ic_d2h_settings)
   - [2.7. IC_D2H_DEV_INFO](#27ic_d2h_dev_info)
- [3. Сервисный режим](#3-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%BD%D1%8B%D0%B9-%D1%80%D0%B5%D0%B6%D0%B8%D0%BC)
- [4. Таблицы идентификаторов](#4-%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D1%8B-%D0%B8%D0%B4%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%D0%BE%D1%80%D0%BE%D0%B2)
   - [4.1. Коды ошибок](#41-%D0%BA%D0%BE%D0%B4%D1%8B-%D0%BE%D1%88%D0%B8%D0%B1%D0%BE%D0%BA)
   - [4.2. Идентификаторы локальных данных](#42-%D0%B8%D0%B4%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%D0%BE%D1%80%D1%8B-%D0%BB%D0%BE%D0%BA%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D1%85-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)
 
   
<div style="page-break-after: always;"></div>

## 1. Введение
### 1.1. Протокол физического уровеня
Гидроакустические модемы [RedLINE](RedLine_Specification_ru.md) поддерживают информационное сопряжение при помощи стандарта физического уровня RS-232 для 
асинхронного интерфейса (UART) c напряжением линии данных 3.3В. Подключение производится при помощи четырехпроводного кабеля, 
с жилами Tx (трансмиттер), Rx (ресивер), Vcc (питание)  и GND (земля). Без применения дополнительных повторителей и преобразователей 
интерфейса максимальная длинна шины данных, для которой гарантируется корректная работа интерфейса, составляет не более 2 метров.  

Настройки порта подключения по умолчанию<sup>[1](#footnote1)</sup>:  
> _Baudrate: 9600 bit/s_  
> _Data bits: 8_  
> _Stop bits: 1_  
> _Parity: No_  
> _Hardware flow control: No_  

>**ВНИМАНИЕ!**
>_Питание модемов осуществляется от источника постоянного тока 12 Вольт, при этом напряжение линии данных составляет 3.3 В._

### 1.2. Стандарт протокола диалогового уровня NMEA0183
Стандарт NMEA0183 описывает формат текстовых (ASCII) сообщений диалогового уровня.  

Пример сообщения:  **`$PTNT0,0*hh<СR><LF>`**  

Основные элементы посылки (сообщения, sentence) NMEА0183:
* '$' - начало сообщения,
* 'P' - Proprietary, проприетарный код
* 'TNT' - трехбуквенный идентификатор производителя
* '0' - идентификатор сообщения
* ',' - запятая (разделитель параметров)  
* '0' - параметр (в данном случае код ошибки)
* '*' - разделитель контрольной суммы
* 'hh' - контрольная сумма в шестнадцатеричном формате (например FF, 01). Рассчитывается как побитовый XOR всех байт между '$' и '*'.
* \<CR\>\<LF\> - конец сообщения (перевод строки)
________
<a name="footnote1"><sup>1</sup> Указанные параметры могут быть изменены по запросу</a>

<div style="page-break-after: always;"></div>

## 2. Система команд TNT для ГА модемов RedLINE
Префикс **D2H** в наименовании сообщений означает, что оно передается от устройства (Device) к управляющей системе (Host).
Префикс **H2D** в наименовании сообщений означает, что оно передается от управляющей системы (Host) к устройству (Device).

### 2.1. IC_D2H_ACK
Сообщение IC_D2H_ACK - реакция устройства на поступивший от управляющей системы запрос.  

Формат сообщения: **`$PTNT0,x*hh<CR><LF>`**  

| Поле/Параметр |	Описание |
| :--- | :--- |
| $	| Начало сообщения '$' |
| PTNT	| TNT |
| 0	| Идентификатор сообщения |
| errCode	| Error code \([см. 4.1](#41-%D0%BA%D0%BE%D0%B4%D1%8B-%D0%BE%D1%88%D0%B8%D0%B1%D0%BE%D0%BA)\) |
| *	| Разделитель контрольной суммы NMEA |
| hh	| Контрольная сумма NMEA |
| \<CR\>\<LF\> | Конец сообщения |

### 2.2. IC_H2D_LOC_DATA_GET
Получить значение локальной переменной.

Формат сообщения: **`$PTNT4,xx,00*hh<CR><LF>`**

| Поле/Параметр |	Описание |
| :--- | :--- |
| $	| Начало сообщения '$' |
| 4	| Идентификатор сообщения |
| Requested data ID	| Идентификатор данных \([см. 4.2](#42-%D0%B8%D0%B4%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%D0%BE%D1%80%D1%8B-%D0%BB%D0%BE%D0%BA%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D1%85-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)\) |
| Reserved	| Зарезервированно, всегда должно быть '00' |
| *	| Разделитель контрольной суммы NMEA |
| hh	| Контрольная сумма NMEA |
| \<CR\>\<LF\> | Конец сообщения |


### 2.3. IC_D2H_LOC_DATA_VAL
Значение локальной переменной.

Формат сообщения: **`$PTNT5,x,x.x*hh<CR><LF>`**

| Поле/Параметр |	Описание |
| :--- | :--- |
| $	| Начало сообщения '$' |
| 5	| Идентификатор сообщения |
| Requested data ID	| Идентификатор данных \([см. 4.2](#42-%D0%B8%D0%B4%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%D0%BE%D1%80%D1%8B-%D0%BB%D0%BE%D0%BA%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D1%85-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)\) |
| Requested data value	| Значение |
| *	| Разделитель контрольной суммы NMEA |
| hh	| Контрольная сумма NMEA |
| \<CR\>\<LF\> | Конец сообщения |


### 2.4. IC_H2D_SETTINGS_WRITE
При помощи данной команды пользователь может задать настройки модема.  

Формат сообщения: **`$PTNT7,x,x,x,x*hh <CR><LF>`**

| Поле/Параметр |	Описание |
| :--- | :--- |
| $	| Начало сообщения '$' |
| PTNT | TNT |
| 7 | Идентификатор сообщения
| rxChID | Идентификатор канала приема
| txChID | Идентификатор канала передаче
| isRTX | ‘1’ – ретрансляция разрашена, ‘0’ – ретрансляция запрещена
| isRVRS | ‘1’ – по умолчанию, при получении данных от управляющей системы по UART модем будет передавать их в обратном канале, ‘0’ – в прямом |
| *	| Разделитель контрольной суммы NMEA |
| hh	| Контрольная сумма NMEA |
| \<CR\>\<LF\> | Конец сообщения |

### 2.5. IC_H2D_SETTINGS_READ
При помощи данной команды пользователь может прочитать настройки модема.  

Формат сообщения: **`$PTNT8,x*hh <CR><LF>`**

| Поле/Параметр |	Описание |
| :--- | :--- |
| $	| Начало сообщения '$' |
| PTNT | TNT |
| 8	Идентификатор сообщения |
| reserved | Зарезервировано. Должно быть ‘0’ |
| *	| Разделитель контрольной суммы NMEA |
| hh | Контрольная сумма NMEA |
| \<CR\>\<LF\> | Конец сообщения |

### 2.6. IC_D2H_SETTINGS
При помощи данной команды устройство сообщает управляющей системе свои текущие настройки.  

Формат сообщения: **`$PTNT9,x,x,x,x*hh <CR><LF>`**

| Поле/Параметр |	Описание |
| :--- | :--- |
| $	| Начало сообщения '$' |
| PTNT | TNT |
| 9 | Идентификатор сообщения
| rxChID | Идентификатор канала приема
| txChID | Идентификатор канала передаче
| isRTX | ‘1’ – ретрансляция разрашена, ‘0’ – ретрансляция запрещена
| isRVRS | ‘1’ – по умолчанию, при получении данных от управляющей системы по UART модем будет передавать их в обратном канале, ‘0’ – в прямом |
| *	| Разделитель контрольной суммы NMEA |
| hh | Контрольная сумма NMEA |
| \<CR\>\<LF\> | Конец сообщения |

### 2.7. IC_D2H_DEV_INFO
При помощи данного сообщения устройство сообщает свои данные: тип устройства, версию программы и серийный номер.  

Формат сообщения: **`$PTNT!,c--c,x,x,c--c,x,c--c*hh<CR><LF>`**

| Поле/Параметр |	Описание |
| :--- | :--- |
| $	| Начало сообщения '$' |
| PTNT | TNT |
| ! | Идентификатор сообщения |
| System moniker | Строка наименование системы |
| System version | Версия системы |
| Device type | Тип устройства |
| Communication subsystem moniker | Строка наименования подсистемы связи с наименованием релиза в квадратных скобках '[]' |
| Communication subsystem version | Версия подсистемы связи |
| Serial number	96-битный серийный номер (строка в шестнадцатеричном формате) |
| *	| Разделитель контрольной суммы NMEA |
| hh | Контрольная сумма NMEA |
| \<CR\>\<LF\> | Конец сообщения |


## 3. Сервисный режим
Модемы [RedLINE](RedLine_Specification_ru.md) предоставляют пользователю т.н. "прозрачный канал", когда все данные, подаваемые устройству на вход, без изменений и их анализа передаются в гидроакустический канал, после чего принимаются другим модемом и в неизменном виде отдаются пользователю на приемной стороне. 
В связи с этим, для того, чтобы иметь возможность производить настройку модемов существует сервисный режим. 

Модемы анализируют входные данные только в сервисном режиме. Для перехода в сервисный режим, жила **"service"** должна быть притянута к +3.3 V. После этого, для выхода из сервисного режима жила **"service"** должна быть притянута к земле.

> **ВНИМАНИЕ!**
> _Жила **"service"** притягивается **ТОЛЬКО** к 3-5 V или земле, подключение ее к более высокому напряжению вызовет **НЕУСТРАНИМУЮ** и **НЕГАРАНТИЙНУЮ** поломку устройства._

> **ВНИМАНИЕ!**
> _Перед включением устройства, жила **"service"** должна быть притянута к земле, иначе устройство войдет в режим обновления программного
> обеспечения._

## 4. Таблицы идентификаторов

### 4.1. Коды ошибок 

| Значение | Наименование | Описание |
| :--- | :--- | :--- |
| 0 | NO_ERROR | Запрос принят |
| 1 | INVALID_SYNTAX | Ошибка синтаксиса |
| 2 | UNSUPPORTED | Команда не поддерживается |
| 3 | TRANSMITTER_BUSY | Передатчик занят |
| 4 | ARGUMENT_OUT_OF_RANGE | Аргумент/параметр вне диапазона допустимых значений |
| 5 | INVALID_OPERATION | Невозможно выполнить операцию в данный момент |
| 6 | UNKNOWN_FIELD_ID | Неизвестное/неподдерживаемое поле |
| 7 | VALUE_UNAVAILIBLE | Запрошенное значение недоступно |
| 8 | RECEIVER_BUSY | Приемник занят |

### 4.2. Идентификаторы локальных данных

| Значение | Наименование | Описание |
| :--- | :--- | :--- |
| 0 | DEVICE_INFO | Информация об устройстве |
| 2 | MAX_SUBSCRIBERS | Максимально возможное число абонентов |
| 6 | PRESSURE_RATING | Максимальное рабочее внешнее гидростатическое давление в барах |

__________

[Назад к содержанию](#%D1%81%D0%BE%D0%B4%D0%B5%D1%80%D0%B6%D0%B0%D0%BD%D0%B8%D0%B5)

